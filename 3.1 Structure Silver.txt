\c dw_silver

-- Table 1: Clients nettoyés avec SCD Type 2
CREATE TABLE silver_customers (
    customer_sk SERIAL PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    email VARCHAR(255),
    phone VARCHAR(20),
    city VARCHAR(100),
    country VARCHAR(50) DEFAULT 'France',
    customer_type VARCHAR(20),
    registration_date DATE,
    source_system VARCHAR(50),
    valid_from TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    valid_to TIMESTAMP DEFAULT '9999-12-31 23:59:59',
    is_active BOOLEAN DEFAULT TRUE,
    CONSTRAINT unique_customer_id UNIQUE (customer_id)
);

-- Table 2: Produits standardisés
CREATE TABLE silver_products (
    product_sk SERIAL PRIMARY KEY,
    product_id VARCHAR(50) NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    category VARCHAR(100),
    brand VARCHAR(100),
    supplier VARCHAR(100),
    unit_price DECIMAL(10,2) NOT NULL,
    cost_price DECIMAL(10,2),
    stock_quantity INTEGER,
    min_stock INTEGER,
    reorder_quantity INTEGER,
    weight_kg DECIMAL(6,3),
    release_date DATE,
    source_system VARCHAR(50),
    valid_from TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    valid_to TIMESTAMP DEFAULT '9999-12-31 23:59:59',
    is_active BOOLEAN DEFAULT TRUE,
    CONSTRAINT unique_product_id UNIQUE (product_id)
);

-- Table 3: Transactions nettoyées
CREATE TABLE silver_transactions (
    transaction_sk SERIAL PRIMARY KEY,
    transaction_id VARCHAR(50) NOT NULL,
    customer_sk INTEGER NOT NULL,
    product_sk INTEGER NOT NULL,
    transaction_date TIMESTAMP NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    total_amount DECIMAL(12,2),
    payment_method VARCHAR(50),
    store_id VARCHAR(50),
    employee_id VARCHAR(50),
    source_system VARCHAR(50),
    load_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_customer FOREIGN KEY (customer_sk) REFERENCES silver_customers(customer_sk),
    CONSTRAINT fk_product FOREIGN KEY (product_sk) REFERENCES silver_products(product_sk)
);

-- Table 4: Qualité des données
CREATE TABLE silver_data_quality (
    id SERIAL PRIMARY KEY,
    table_name VARCHAR(100),
    check_type VARCHAR(50),
    check_description TEXT,
    rows_affected INTEGER,
    status VARCHAR(20),
    check_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index pour performances
CREATE INDEX idx_silver_customers_city ON silver_customers(city);
CREATE INDEX idx_silver_products_category ON silver_products(category);
CREATE INDEX idx_silver_transactions_date ON silver_transactions(transaction_date);
CREATE INDEX idx_silver_transactions_customer ON silver_transactions(customer_sk);
CREATE INDEX idx_silver_transactions_product ON silver_transactions(product_sk);
