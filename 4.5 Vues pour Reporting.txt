-- Vue des ventes détaillées
CREATE VIEW vw_sales_detailed AS
SELECT 
    dd.date,
    dc.customer_name,
    dc.city AS customer_city,
    dp.product_name,
    dp.category,
    ds.store_name,
    de.employee_name,
    fs.transaction_id,
    fs.quantity,
    fs.unit_price,
    fs.discount_amount,
    fs.total_amount,
    fs.cost_amount,
    fs.profit_amount,
    fs.payment_method
FROM fact_sales fs
INNER JOIN dim_date dd ON fs.date_key = dd.date_key
INNER JOIN dim_customer dc ON fs.customer_key = dc.customer_key
INNER JOIN dim_product dp ON fs.product_key = dp.product_key
INNER JOIN dim_store ds ON fs.store_key = ds.store_key
LEFT JOIN dim_employee de ON fs.employee_key = de.employee_key
WHERE dc.current_flag = TRUE 
  AND dp.current_flag = TRUE;

-- Vue des ventes par jour
CREATE VIEW vw_daily_sales AS
SELECT 
    dd.date,
    dd.day_name,
    dd.month_name,
    dd.year,
    COUNT(DISTINCT fs.transaction_id) AS nb_transactions,
    SUM(fs.quantity) AS total_quantity,
    SUM(fs.total_amount) AS total_sales,
    SUM(fs.profit_amount) AS total_profit,
    AVG(fs.total_amount) AS avg_transaction_value
FROM fact_sales fs
INNER JOIN dim_date dd ON fs.date_key = dd.date_key
GROUP BY dd.date, dd.day_name, dd.month_name, dd.year
ORDER BY dd.date DESC;

-- Vue des meilleurs clients
CREATE VIEW vw_top_customers AS
SELECT 
    dc.customer_name,
    dc.city,
    dc.customer_segment,
    COUNT(DISTINCT fs.transaction_id) AS nb_purchases,
    SUM(fs.total_amount) AS total_spent,
    SUM(fs.profit_amount) AS total_profit_generated
FROM fact_sales fs
INNER JOIN dim_customer dc ON fs.customer_key = dc.customer_key
WHERE dc.current_flag = TRUE
GROUP BY dc.customer_key, dc.customer_name, dc.city, dc.customer_segment
ORDER BY total_spent DESC
LIMIT 10;

-- Vue des produits les plus vendus
CREATE VIEW vw_top_products AS
SELECT 
    dp.product_name,
    dp.category,
    dp.brand,
    SUM(fs.quantity) AS total_quantity_sold,
    SUM(fs.total_amount) AS total_revenue,
    SUM(fs.profit_amount) AS total_profit,
    ROUND(AVG(dp.profit_margin), 2) AS avg_profit_margin
FROM fact_sales fs
INNER JOIN dim_product dp ON fs.product_key = dp.product_key
WHERE dp.current_flag = TRUE
GROUP BY dp.product_key, dp.product_name, dp.category, dp.brand
ORDER BY total_revenue DESC
LIMIT 10;
